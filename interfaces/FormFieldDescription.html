<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>ceph-dashboard documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">ceph-dashboard documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>FormFieldDescription</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/ceph/pool/pool-form/pool-form.component.ts</code>
        </p>



        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#attr">attr</a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#editable">editable</a>
                                </li>
                                <li>
                                        <a href="#externalFieldName">externalFieldName</a>
                                </li>
                                <li>
                                        <a href="#formControlName">formControlName</a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#replaceFn">replaceFn</a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#resetValue">resetValue</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="attr"></a>
                                        <span class="name"><b>attr</b><a href="#attr"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>attr:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="editable"></a>
                                        <span class="name"><b>editable</b><a href="#editable"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>editable:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="externalFieldName"></a>
                                        <span class="name"><b>externalFieldName</b><a href="#externalFieldName"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>externalFieldName:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="formControlName"></a>
                                        <span class="name"><b>formControlName</b><a href="#formControlName"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>formControlName:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="replaceFn"></a>
                                        <span class="name"><b>replaceFn</b><a href="#replaceFn"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>replaceFn:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank" >Function</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank" >Function</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="resetValue"></a>
                                        <span class="name"><b>resetValue</b><a href="#resetValue"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>resetValue:         <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, EventEmitter, OnInit } from &#x27;@angular/core&#x27;;
import { FormControl, Validators } from &#x27;@angular/forms&#x27;;
import { ActivatedRoute, Router } from &#x27;@angular/router&#x27;;

import { I18n } from &#x27;@ngx-translate/i18n-polyfill&#x27;;
import * as _ from &#x27;lodash&#x27;;
import { BsModalService } from &#x27;ngx-bootstrap/modal&#x27;;
import { forkJoin, Subscription } from &#x27;rxjs&#x27;;

import { ErasureCodeProfileService } from &#x27;../../../shared/api/erasure-code-profile.service&#x27;;
import { PoolService } from &#x27;../../../shared/api/pool.service&#x27;;
import { CriticalConfirmationModalComponent } from &#x27;../../../shared/components/critical-confirmation-modal/critical-confirmation-modal.component&#x27;;
import { ActionLabelsI18n, URLVerbs } from &#x27;../../../shared/constants/app.constants&#x27;;
import { CdFormGroup } from &#x27;../../../shared/forms/cd-form-group&#x27;;
import { CdValidators } from &#x27;../../../shared/forms/cd-validators&#x27;;
import {
  RbdConfigurationEntry,
  RbdConfigurationSourceField
} from &#x27;../../../shared/models/configuration&#x27;;
import { CrushRule } from &#x27;../../../shared/models/crush-rule&#x27;;
import { CrushStep } from &#x27;../../../shared/models/crush-step&#x27;;
import { ErasureCodeProfile } from &#x27;../../../shared/models/erasure-code-profile&#x27;;
import { FinishedTask } from &#x27;../../../shared/models/finished-task&#x27;;
import { Permission } from &#x27;../../../shared/models/permissions&#x27;;
import { PoolFormInfo } from &#x27;../../../shared/models/pool-form-info&#x27;;
import { DimlessBinaryPipe } from &#x27;../../../shared/pipes/dimless-binary.pipe&#x27;;
import { AuthStorageService } from &#x27;../../../shared/services/auth-storage.service&#x27;;
import { FormatterService } from &#x27;../../../shared/services/formatter.service&#x27;;
import { TaskWrapperService } from &#x27;../../../shared/services/task-wrapper.service&#x27;;
import { ErasureCodeProfileFormComponent } from &#x27;../erasure-code-profile-form/erasure-code-profile-form.component&#x27;;
import { Pool } from &#x27;../pool&#x27;;
import { PoolFormData } from &#x27;./pool-form-data&#x27;;

interface FormFieldDescription {
  externalFieldName: string;
  formControlName: string;
  attr?: string;
  replaceFn?: Function;
  editable?: boolean;
  resetValue?: any;
}

@Component({
  selector: &#x27;cd-pool-form&#x27;,
  templateUrl: &#x27;./pool-form.component.html&#x27;,
  styleUrls: [&#x27;./pool-form.component.scss&#x27;]
})
export class PoolFormComponent implements OnInit {
  permission: Permission;
  form: CdFormGroup;
  ecProfiles: ErasureCodeProfile[];
  info: PoolFormInfo;
  routeParamsSubscribe: any;
  editing &#x3D; false;
  data &#x3D; new PoolFormData(this.i18n);
  externalPgChange &#x3D; false;
  private modalSubscription: Subscription;
  current &#x3D; {
    rules: []
  };
  initializeConfigData &#x3D; new EventEmitter&lt;{
    initialData: RbdConfigurationEntry[];
    sourceType: RbdConfigurationSourceField;
  }&gt;();
  currentConfigurationValues: { [configKey: string]: any } &#x3D; {};
  action: string;
  resource: string;

  constructor(
    private dimlessBinaryPipe: DimlessBinaryPipe,
    private route: ActivatedRoute,
    private router: Router,
    private modalService: BsModalService,
    private poolService: PoolService,
    private authStorageService: AuthStorageService,
    private formatter: FormatterService,
    private bsModalService: BsModalService,
    private taskWrapper: TaskWrapperService,
    private ecpService: ErasureCodeProfileService,
    private i18n: I18n,
    public actionLabels: ActionLabelsI18n
  ) {
    this.editing &#x3D; this.router.url.startsWith(&#x60;/pool/${URLVerbs.EDIT}&#x60;);
    this.action &#x3D; this.editing ? this.actionLabels.EDIT : this.actionLabels.CREATE;
    this.resource &#x3D; this.i18n(&#x27;pool&#x27;);
    this.authenticate();
    this.createForm();
  }

  authenticate() {
    this.permission &#x3D; this.authStorageService.getPermissions().pool;
    if (
      !this.permission.read ||
      ((!this.permission.update &amp;&amp; this.editing) || (!this.permission.create &amp;&amp; !this.editing))
    ) {
      this.router.navigate([&#x27;/404&#x27;]);
    }
  }

  private createForm() {
    const compressionForm &#x3D; new CdFormGroup({
      mode: new FormControl(&#x27;none&#x27;),
      algorithm: new FormControl(&#x27;&#x27;),
      minBlobSize: new FormControl(&#x27;&#x27;, {
        updateOn: &#x27;blur&#x27;
      }),
      maxBlobSize: new FormControl(&#x27;&#x27;, {
        updateOn: &#x27;blur&#x27;
      }),
      ratio: new FormControl(&#x27;&#x27;, {
        updateOn: &#x27;blur&#x27;
      })
    });

    this.form &#x3D; new CdFormGroup(
      {
        name: new FormControl(&#x27;&#x27;, {
          validators: [Validators.pattern(/^[\.A-Za-z0-9_/-]+$/), Validators.required]
        }),
        poolType: new FormControl(&#x27;&#x27;, {
          validators: [Validators.required]
        }),
        crushRule: new FormControl(null, {
          validators: [
            CdValidators.custom(
              &#x27;tooFewOsds&#x27;,
              (rule) &#x3D;&gt; this.info &amp;&amp; rule &amp;&amp; this.info.osd_count &lt; rule.min_size
            )
          ]
        }),
        size: new FormControl(&#x27;&#x27;, {
          updateOn: &#x27;blur&#x27;
        }),
        erasureProfile: new FormControl(null),
        pgNum: new FormControl(&#x27;&#x27;, {
          validators: [Validators.required, Validators.min(1)]
        }),
        ecOverwrites: new FormControl(false),
        compression: compressionForm
      },
      [
        CdValidators.custom(&#x27;form&#x27;, () &#x3D;&gt; null),
        CdValidators.custom(&#x27;rbdPool&#x27;, () &#x3D;&gt; {
          return (
            this.form &amp;&amp;
            this.form.getValue(&#x27;name&#x27;).includes(&#x27;/&#x27;) &amp;&amp;
            this.data &amp;&amp;
            this.data.applications.selected.indexOf(&#x27;rbd&#x27;) !&#x3D;&#x3D; -1
          );
        })
      ]
    );
  }

  ngOnInit() {
    forkJoin(this.poolService.getInfo(), this.ecpService.list()).subscribe(
      (data: [PoolFormInfo, ErasureCodeProfile[]]) &#x3D;&gt; {
        this.initInfo(data[0]);
        this.initEcp(data[1]);
        if (this.editing) {
          this.initEditMode();
        }
        this.listenToChanges();
        this.setComplexValidators();
      }
    );
  }

  private initInfo(info: PoolFormInfo) {
    this.form.silentSet(&#x27;algorithm&#x27;, info.bluestore_compression_algorithm);
    info.compression_modes.push(&#x27;unset&#x27;);
    this.info &#x3D; info;
  }

  private initEcp(ecProfiles: ErasureCodeProfile[]) {
    const control &#x3D; this.form.get(&#x27;erasureProfile&#x27;);
    if (ecProfiles.length &lt;&#x3D; 1) {
      control.disable();
    }
    if (ecProfiles.length &#x3D;&#x3D;&#x3D; 1) {
      control.setValue(ecProfiles[0]);
    } else if (ecProfiles.length &gt; 1 &amp;&amp; control.disabled) {
      control.enable();
    }
    this.ecProfiles &#x3D; ecProfiles;
  }

  private initEditMode() {
    this.disableForEdit();
    this.routeParamsSubscribe &#x3D; this.route.params.subscribe((param: { name: string }) &#x3D;&gt;
      this.poolService.get(param.name).subscribe((pool: Pool) &#x3D;&gt; {
        this.data.pool &#x3D; pool;
        this.initEditFormData(pool);
      })
    );
  }

  private disableForEdit() {
    [&#x27;poolType&#x27;, &#x27;crushRule&#x27;, &#x27;size&#x27;, &#x27;erasureProfile&#x27;, &#x27;ecOverwrites&#x27;].forEach((controlName) &#x3D;&gt;
      this.form.get(controlName).disable()
    );
  }

  private initEditFormData(pool: Pool) {
    this.initializeConfigData.emit({
      initialData: pool.configuration,
      sourceType: RbdConfigurationSourceField.pool
    });

    const dataMap &#x3D; {
      name: pool.pool_name,
      poolType: pool.type,
      crushRule: this.info[&#x27;crush_rules_&#x27; + pool.type].find(
        (rule: CrushRule) &#x3D;&gt; rule.rule_name &#x3D;&#x3D;&#x3D; pool.crush_rule
      ),
      size: pool.size,
      erasureProfile: this.ecProfiles.find((ecp) &#x3D;&gt; ecp.name &#x3D;&#x3D;&#x3D; pool.erasure_code_profile),
      pgNum: pool.pg_num,
      ecOverwrites: pool.flags_names.includes(&#x27;ec_overwrites&#x27;),
      mode: pool.options.compression_mode,
      algorithm: pool.options.compression_algorithm,
      minBlobSize: this.dimlessBinaryPipe.transform(pool.options.compression_min_blob_size),
      maxBlobSize: this.dimlessBinaryPipe.transform(pool.options.compression_max_blob_size),
      ratio: pool.options.compression_required_ratio
    };

    Object.keys(dataMap).forEach((controlName: string) &#x3D;&gt; {
      const value &#x3D; dataMap[controlName];
      if (!_.isUndefined(value) &amp;&amp; value !&#x3D;&#x3D; &#x27;&#x27;) {
        this.form.silentSet(controlName, value);
      }
    });
    this.data.applications.selected &#x3D; pool.application_metadata;
  }

  private listenToChanges() {
    this.listenToChangesDuringAddEdit();
    if (!this.editing) {
      this.listenToChangesDuringAdd();
    }
  }

  private listenToChangesDuringAddEdit() {
    this.form.get(&#x27;pgNum&#x27;).valueChanges.subscribe((pgs) &#x3D;&gt; {
      const change &#x3D; pgs - this.data.pgs;
      if (Math.abs(change) !&#x3D;&#x3D; 1 || pgs &#x3D;&#x3D;&#x3D; 2) {
        this.data.pgs &#x3D; pgs;
        return;
      }
      this.doPgPowerJump(change as 1 | -1);
    });
  }

  private doPgPowerJump(jump: 1 | -1) {
    const power &#x3D; this.calculatePgPower() + jump;
    this.setPgs(jump &#x3D;&#x3D;&#x3D; -1 ? Math.round(power) : Math.floor(power));
  }

  private calculatePgPower(pgs &#x3D; this.form.getValue(&#x27;pgNum&#x27;)): number {
    return Math.log(pgs) / Math.log(2);
  }

  private setPgs(power: number) {
    const pgs &#x3D; Math.pow(2, power &lt; 0 ? 0 : power); // Set size the nearest accurate size.
    this.data.pgs &#x3D; pgs;
    this.form.silentSet(&#x27;pgNum&#x27;, pgs);
  }

  private listenToChangesDuringAdd() {
    this.form.get(&#x27;poolType&#x27;).valueChanges.subscribe((poolType) &#x3D;&gt; {
      this.form.get(&#x27;size&#x27;).updateValueAndValidity();
      this.rulesChange();
      if (poolType &#x3D;&#x3D;&#x3D; &#x27;replicated&#x27;) {
        this.replicatedRuleChange();
      }
      this.pgCalc();
    });
    this.form.get(&#x27;crushRule&#x27;).valueChanges.subscribe(() &#x3D;&gt; {
      if (this.form.getValue(&#x27;poolType&#x27;) &#x3D;&#x3D;&#x3D; &#x27;replicated&#x27;) {
        this.replicatedRuleChange();
      }
      this.pgCalc();
    });
    this.form.get(&#x27;size&#x27;).valueChanges.subscribe(() &#x3D;&gt; {
      this.pgCalc();
    });
    this.form.get(&#x27;erasureProfile&#x27;).valueChanges.subscribe(() &#x3D;&gt; {
      this.pgCalc();
    });
    this.form.get(&#x27;mode&#x27;).valueChanges.subscribe(() &#x3D;&gt; {
      [&#x27;minBlobSize&#x27;, &#x27;maxBlobSize&#x27;, &#x27;ratio&#x27;].forEach((name) &#x3D;&gt; {
        this.form.get(name).updateValueAndValidity({ emitEvent: false });
      });
    });
    this.form.get(&#x27;minBlobSize&#x27;).valueChanges.subscribe(() &#x3D;&gt; {
      this.form.get(&#x27;maxBlobSize&#x27;).updateValueAndValidity({ emitEvent: false });
    });
    this.form.get(&#x27;maxBlobSize&#x27;).valueChanges.subscribe(() &#x3D;&gt; {
      this.form.get(&#x27;minBlobSize&#x27;).updateValueAndValidity({ emitEvent: false });
    });
  }

  private rulesChange() {
    const poolType &#x3D; this.form.getValue(&#x27;poolType&#x27;);
    if (!poolType || !this.info) {
      this.current.rules &#x3D; [];
      return;
    }
    const rules &#x3D; this.info[&#x27;crush_rules_&#x27; + poolType] || [];
    const control &#x3D; this.form.get(&#x27;crushRule&#x27;);
    if (rules.length &#x3D;&#x3D;&#x3D; 1) {
      control.setValue(rules[0]);
      control.disable();
    } else {
      control.setValue(null);
      control.enable();
    }
    this.current.rules &#x3D; rules;
  }

  private replicatedRuleChange() {
    if (this.form.getValue(&#x27;poolType&#x27;) !&#x3D;&#x3D; &#x27;replicated&#x27;) {
      return;
    }
    const control &#x3D; this.form.get(&#x27;size&#x27;);
    let size &#x3D; this.form.getValue(&#x27;size&#x27;) || 3;
    const min &#x3D; this.getMinSize();
    const max &#x3D; this.getMaxSize();
    if (size &lt; min) {
      size &#x3D; min;
    } else if (size &gt; max) {
      size &#x3D; max;
    }
    if (size !&#x3D;&#x3D; control.value) {
      this.form.silentSet(&#x27;size&#x27;, size);
    }
  }

  getMinSize(): number {
    if (!this.info || this.info.osd_count &lt; 1) {
      return;
    }
    const rule &#x3D; this.form.getValue(&#x27;crushRule&#x27;);
    if (rule) {
      return rule.min_size;
    }
    return 1;
  }

  getMaxSize(): number {
    if (!this.info || this.info.osd_count &lt; 1) {
      return;
    }
    const osds: number &#x3D; this.info.osd_count;
    if (this.form.getValue(&#x27;crushRule&#x27;)) {
      const max: number &#x3D; this.form.get(&#x27;crushRule&#x27;).value.max_size;
      if (max &lt; osds) {
        return max;
      }
    }
    return osds;
  }

  private pgCalc() {
    const poolType &#x3D; this.form.getValue(&#x27;poolType&#x27;);
    if (!this.info || this.form.get(&#x27;pgNum&#x27;).dirty || !poolType) {
      return;
    }
    const pgMax &#x3D; this.info.osd_count * 100;
    const pgs &#x3D;
      poolType &#x3D;&#x3D;&#x3D; &#x27;replicated&#x27; ? this.replicatedPgCalc(pgMax) : this.erasurePgCalc(pgMax);
    if (!pgs) {
      return;
    }
    const oldValue &#x3D; this.data.pgs;
    this.alignPgs(pgs);
    const newValue &#x3D; this.data.pgs;
    if (!this.externalPgChange) {
      this.externalPgChange &#x3D; oldValue !&#x3D;&#x3D; newValue;
    }
  }

  private replicatedPgCalc(pgs): number {
    const sizeControl &#x3D; this.form.get(&#x27;size&#x27;);
    const size &#x3D; sizeControl.value;
    if (sizeControl.valid &amp;&amp; size &gt; 0) {
      return pgs / size;
    }
  }

  private erasurePgCalc(pgs): number {
    const ecpControl &#x3D; this.form.get(&#x27;erasureProfile&#x27;);
    const ecp &#x3D; ecpControl.value;
    if ((ecpControl.valid || ecpControl.disabled) &amp;&amp; ecp) {
      return pgs / (ecp.k + ecp.m);
    }
  }

  private alignPgs(pgs &#x3D; this.form.getValue(&#x27;pgNum&#x27;)) {
    this.setPgs(Math.round(this.calculatePgPower(pgs &lt; 1 ? 1 : pgs)));
  }

  private setComplexValidators() {
    if (this.editing) {
      this.form
        .get(&#x27;pgNum&#x27;)
        .setValidators(
          CdValidators.custom(&#x27;noDecrease&#x27;, (pgs) &#x3D;&gt; this.data.pool &amp;&amp; pgs &lt; this.data.pool.pg_num)
        );
      this.form
        .get(&#x27;name&#x27;)
        .setValidators([
          this.form.get(&#x27;name&#x27;).validator,
          CdValidators.custom(
            &#x27;uniqueName&#x27;,
            (name) &#x3D;&gt;
              this.data.pool &amp;&amp;
              this.info &amp;&amp;
              this.info.pool_names.indexOf(name) !&#x3D;&#x3D; -1 &amp;&amp;
              this.info.pool_names.indexOf(name) !&#x3D;&#x3D;
                this.info.pool_names.indexOf(this.data.pool.pool_name)
          )
        ]);
    } else {
      CdValidators.validateIf(
        this.form.get(&#x27;size&#x27;),
        () &#x3D;&gt; this.form.get(&#x27;poolType&#x27;).value &#x3D;&#x3D;&#x3D; &#x27;replicated&#x27;,
        [
          CdValidators.custom(
            &#x27;min&#x27;,
            (value) &#x3D;&gt; this.form.getValue(&#x27;size&#x27;) &amp;&amp; value &lt; this.getMinSize()
          ),
          CdValidators.custom(
            &#x27;max&#x27;,
            (value) &#x3D;&gt; this.form.getValue(&#x27;size&#x27;) &amp;&amp; this.getMaxSize() &lt; value
          )
        ]
      );
      this.form
        .get(&#x27;name&#x27;)
        .setValidators([
          this.form.get(&#x27;name&#x27;).validator,
          CdValidators.custom(
            &#x27;uniqueName&#x27;,
            (name) &#x3D;&gt; this.info &amp;&amp; this.info.pool_names.indexOf(name) !&#x3D;&#x3D; -1
          )
        ]);
    }
    this.setCompressionValidators();
  }

  private setCompressionValidators() {
    CdValidators.validateIf(this.form.get(&#x27;minBlobSize&#x27;), () &#x3D;&gt; this.hasCompressionEnabled(), [
      Validators.min(0),
      CdValidators.custom(&#x27;maximum&#x27;, (size) &#x3D;&gt;
        this.oddBlobSize(size, this.form.getValue(&#x27;maxBlobSize&#x27;))
      )
    ]);
    CdValidators.validateIf(this.form.get(&#x27;maxBlobSize&#x27;), () &#x3D;&gt; this.hasCompressionEnabled(), [
      Validators.min(0),
      CdValidators.custom(&#x27;minimum&#x27;, (size) &#x3D;&gt;
        this.oddBlobSize(this.form.getValue(&#x27;minBlobSize&#x27;), size)
      )
    ]);
    CdValidators.validateIf(this.form.get(&#x27;ratio&#x27;), () &#x3D;&gt; this.hasCompressionEnabled(), [
      Validators.min(0),
      Validators.max(1)
    ]);
  }

  private oddBlobSize(minimum, maximum) {
    minimum &#x3D; this.formatter.toBytes(minimum);
    maximum &#x3D; this.formatter.toBytes(maximum);
    return Boolean(minimum &amp;&amp; maximum &amp;&amp; minimum &gt;&#x3D; maximum);
  }

  hasCompressionEnabled() {
    return this.form.getValue(&#x27;mode&#x27;) &amp;&amp; this.form.get(&#x27;mode&#x27;).value.toLowerCase() !&#x3D;&#x3D; &#x27;none&#x27;;
  }

  describeCrushStep(step: CrushStep) {
    return [
      step.op.replace(&#x27;_&#x27;, &#x27; &#x27;),
      step.item_name || &#x27;&#x27;,
      step.type ? step.num + &#x27; type &#x27; + step.type : &#x27;&#x27;
    ].join(&#x27; &#x27;);
  }

  addErasureCodeProfile() {
    this.modalSubscription &#x3D; this.modalService.onHide.subscribe(() &#x3D;&gt; this.reloadECPs());
    this.bsModalService.show(ErasureCodeProfileFormComponent);
  }

  private reloadECPs() {
    this.ecpService.list().subscribe((profiles: ErasureCodeProfile[]) &#x3D;&gt; this.initEcp(profiles));
    this.modalSubscription.unsubscribe();
  }

  deleteErasureCodeProfile() {
    const ecp &#x3D; this.form.getValue(&#x27;erasureProfile&#x27;);
    if (!ecp) {
      return;
    }
    const name &#x3D; ecp.name;
    this.modalSubscription &#x3D; this.modalService.onHide.subscribe(() &#x3D;&gt; this.reloadECPs());
    this.modalService.show(CriticalConfirmationModalComponent, {
      initialState: {
        itemDescription: this.i18n(&#x27;erasure code profile&#x27;),
        submitActionObservable: () &#x3D;&gt;
          this.taskWrapper.wrapTaskAroundCall({
            task: new FinishedTask(&#x27;ecp/delete&#x27;, { name: name }),
            call: this.ecpService.delete(name)
          })
      }
    });
  }

  submit() {
    if (this.form.invalid) {
      this.form.setErrors({ cdSubmitButton: true });
      return;
    }

    const pool &#x3D; { pool: this.form.getValue(&#x27;name&#x27;) };

    this.assignFormFields(pool, [
      { externalFieldName: &#x27;pool_type&#x27;, formControlName: &#x27;poolType&#x27; },
      { externalFieldName: &#x27;pg_num&#x27;, formControlName: &#x27;pgNum&#x27;, editable: true },
      this.form.getValue(&#x27;poolType&#x27;) &#x3D;&#x3D;&#x3D; &#x27;replicated&#x27;
        ? { externalFieldName: &#x27;size&#x27;, formControlName: &#x27;size&#x27; }
        : {
            externalFieldName: &#x27;erasure_code_profile&#x27;,
            formControlName: &#x27;erasureProfile&#x27;,
            attr: &#x27;name&#x27;
          },
      { externalFieldName: &#x27;rule_name&#x27;, formControlName: &#x27;crushRule&#x27;, attr: &#x27;rule_name&#x27; }
    ]);

    if (this.info.is_all_bluestore) {
      this.assignFormField(pool, {
        externalFieldName: &#x27;flags&#x27;,
        formControlName: &#x27;ecOverwrites&#x27;,
        replaceFn: () &#x3D;&gt; [&#x27;ec_overwrites&#x27;]
      });

      if (this.form.getValue(&#x27;mode&#x27;) !&#x3D;&#x3D; &#x27;none&#x27;) {
        this.assignFormFields(pool, [
          {
            externalFieldName: &#x27;compression_mode&#x27;,
            formControlName: &#x27;mode&#x27;,
            editable: true,
            replaceFn: (value) &#x3D;&gt; this.hasCompressionEnabled() &amp;&amp; value
          },
          {
            externalFieldName: &#x27;compression_algorithm&#x27;,
            formControlName: &#x27;algorithm&#x27;,
            editable: true
          },
          {
            externalFieldName: &#x27;compression_min_blob_size&#x27;,
            formControlName: &#x27;minBlobSize&#x27;,
            replaceFn: this.formatter.toBytes,
            editable: true,
            resetValue: 0
          },
          {
            externalFieldName: &#x27;compression_max_blob_size&#x27;,
            formControlName: &#x27;maxBlobSize&#x27;,
            replaceFn: this.formatter.toBytes,
            editable: true,
            resetValue: 0
          },
          {
            externalFieldName: &#x27;compression_required_ratio&#x27;,
            formControlName: &#x27;ratio&#x27;,
            editable: true,
            resetValue: 0
          }
        ]);
      } else if (this.editing) {
        this.assignFormFields(pool, [
          {
            externalFieldName: &#x27;compression_mode&#x27;,
            formControlName: &#x27;mode&#x27;,
            editable: true,
            replaceFn: () &#x3D;&gt; &#x27;unset&#x27;
          },
          {
            externalFieldName: &#x27;srcpool&#x27;,
            formControlName: &#x27;name&#x27;,
            editable: true,
            replaceFn: () &#x3D;&gt; this.data.pool.pool_name
          }
        ]);
      }
    }

    const apps &#x3D; this.data.applications.selected;
    if (apps.length &gt; 0 || this.editing) {
      pool[&#x27;application_metadata&#x27;] &#x3D; apps;
    }

    // Only collect configuration data for replicated pools, as QoS cannot be configured on EC
    // pools. EC data pools inherit their settings from the corresponding replicated metadata pool.
    if (
      this.form.get(&#x27;poolType&#x27;).value &#x3D;&#x3D;&#x3D; &#x27;replicated&#x27; &amp;&amp;
      !_.isEmpty(this.currentConfigurationValues)
    ) {
      pool[&#x27;configuration&#x27;] &#x3D; this.currentConfigurationValues;
    }

    this.triggerApiTask(pool);
  }

  /**
   * Retrieves the values for the given form field descriptions and assigns the values to the given
   * object. This method differentiates between &#x60;add&#x60; and &#x60;edit&#x60; mode and acts differently on one or
   * the other.
   */
  private assignFormFields(pool: object, formFieldDescription: FormFieldDescription[]): void {
    formFieldDescription.forEach((item) &#x3D;&gt; this.assignFormField(pool, item));
  }

  /**
   * Retrieves the value for the given form field description and assigns the values to the given
   * object. This method differentiates between &#x60;add&#x60; and &#x60;edit&#x60; mode and acts differently on one or
   * the other.
   */
  private assignFormField(
    pool: object,
    {
      externalFieldName,
      formControlName,
      attr,
      replaceFn,
      editable,
      resetValue
    }: FormFieldDescription
  ): void {
    if (this.editing &amp;&amp; (!editable || this.form.get(formControlName).pristine)) {
      return;
    }
    const value &#x3D; this.form.getValue(formControlName);
    let apiValue &#x3D; replaceFn ? replaceFn(value) : attr ? _.get(value, attr) : value;
    if (!value || !apiValue) {
      if (editable &amp;&amp; !_.isUndefined(resetValue)) {
        apiValue &#x3D; resetValue;
      } else {
        return;
      }
    }
    pool[externalFieldName] &#x3D; apiValue;
  }

  private triggerApiTask(pool) {
    this.taskWrapper
      .wrapTaskAroundCall({
        task: new FinishedTask(&#x27;pool/&#x27; + (this.editing ? URLVerbs.EDIT : URLVerbs.CREATE), {
          pool_name: pool.hasOwnProperty(&#x27;srcpool&#x27;) ? pool.srcpool : pool.pool
        }),
        call: this.poolService[this.editing ? URLVerbs.UPDATE : URLVerbs.CREATE](pool)
      })
      .subscribe(
        undefined,
        (resp) &#x3D;&gt; {
          if (_.isObject(resp.error) &amp;&amp; resp.error.code &#x3D;&#x3D;&#x3D; &#x27;34&#x27;) {
            this.form.get(&#x27;pgNum&#x27;).setErrors({ &#x27;34&#x27;: true });
          }
          this.form.setErrors({ cdSubmitButton: true });
        },
        () &#x3D;&gt; this.router.navigate([&#x27;/pool&#x27;])
      );
  }

  appSelection() {
    this.form.updateValueAndValidity({ emitEvent: false, onlySelf: true });
  }
}
</code></pre>
    </div>
</div>






                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'FormFieldDescription.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
